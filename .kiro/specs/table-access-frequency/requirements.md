# Requirements Document

## Introduction
BigQueryのINFORMATION_SCHEMAから、各テーブルの参照回数を計算する機能を提供する。データ基盤運用者やデータエンジニアがテーブルの利用状況を正確に把握できるようにし、分析で既に利用されていないテーブルを明らかにする材料を作る。

## Requirements

### Requirement 1: INFORMATION_SCHEMAからのテーブル参照回数取得
**Objective:** データエンジニアとして、INFORMATION_SCHEMA.JOBSからテーブルの参照回数を取得したい。これにより、BigQueryネイティブのメタデータを活用して利用状況を把握できる。

#### Acceptance Criteria
1. ユーザーがプロジェクトIDを指定して実行した場合、テーブル参照回数取得機能はINFORMATION_SCHEMA.JOBS_BY_PROJECTからクエリジョブの実行履歴を取得する
2. クエリジョブの実行履歴を取得した場合、テーブル参照回数取得機能はreferenced_tablesフィールドからテーブル参照情報を抽出する
3. テーブル参照情報を抽出した場合、テーブル参照回数取得機能はプロジェクト、データセット、テーブル単位で参照回数と参照UUを集計する
4. テーブル参照回数取得機能は過去の期間（デフォルト180日）のジョブ履歴を対象に集計する
5. INFORMATION_SCHEMAへのアクセス権限がない場合、テーブル参照回数取得機能は明確なエラーメッセージを表示する

### Requirement 2: 結果の出力
**Objective:** データ基盤運用者として、テーブル参照回数の結果をcsv形式で出力したい。

#### Acceptance Criteria
1. 集計が完了した場合、テーブル参照回数取得機能はテーブル名と参照回数の一覧をcsv形式でファイル保存する
2. テーブル参照回数取得機能は集計結果のファイルをdataディレクトリに保存する
5. テーブル参照回数取得機能は出力結果にプロジェクトID、データセット名、テーブル名、参照回数、参照UUを含める

### Requirement 3: フィルタリングと期間指定
**Objective:** データエンジニアとして、特定の条件でフィルタリングや期間を指定したい。これにより、必要な範囲に絞った分析ができる。

#### Acceptance Criteria
1. ユーザーがデータセット名のプレフィックスを指定した場合、テーブル参照回数取得機能はプレフィックスに一致するデータセットのみを集計対象とする
2. ユーザーは必ずデータセット名のプレフィックスを指定必ず指定しなければならず、もし指定していなかった場合はエラーとしてユーザーに通知する

### Requirement 4: エラーハンドリングと堅牢性
**Objective:** データエンジニアとして、エラーが発生しても適切に処理されることを期待したい。これにより、安定した運用ができる。

#### Acceptance Criteria
1. BigQuery APIへの接続が失敗した場合、テーブル参照回数取得機能は接続エラーの詳細とリトライの方法を表示する
2. 認証情報が無効または期限切れの場合、テーブル参照回数取得機能は認証の再設定方法を案内する
3. クエリ実行中にタイムアウトが発生した場合、テーブル参照回数取得機能はタイムアウト設定の調整方法を表示する
4. 予期しないエラーが発生した場合、テーブル参照回数取得機能はエラーログを出力し、ユーザーにフィードバックを提供する
