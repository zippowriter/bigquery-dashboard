# Requirements Document

## Introduction
BigQueryのINFORMATION_SCHEMAとauditlogの両方から、各テーブルの参照回数を計算する機能を提供する。データ基盤運用者やデータエンジニアが、テーブルの利用状況を正確に把握し、データガバナンスやリソース最適化の意思決定を支援する。

## Requirements

### Requirement 1: INFORMATION_SCHEMAからのテーブル参照回数取得
**Objective:** データエンジニアとして、INFORMATION_SCHEMA.JOBSからテーブルの参照回数を取得したい。これにより、BigQueryネイティブのメタデータを活用して利用状況を把握できる。

#### Acceptance Criteria
1. ユーザーがプロジェクトIDを指定して実行した場合、テーブル参照回数取得機能はINFORMATION_SCHEMA.JOBS_BY_PROJECTからクエリジョブの実行履歴を取得する
2. クエリジョブの実行履歴を取得した場合、テーブル参照回数取得機能はreferenced_tablesフィールドからテーブル参照情報を抽出する
3. テーブル参照情報を抽出した場合、テーブル参照回数取得機能はプロジェクト、データセット、テーブル単位で参照回数を集計する
4. テーブル参照回数取得機能は過去の期間（デフォルト30日）のジョブ履歴を対象に集計する
5. INFORMATION_SCHEMAへのアクセス権限がない場合、テーブル参照回数取得機能は明確なエラーメッセージを表示する

### Requirement 2: auditlogからのテーブル参照回数取得
**Objective:** データエンジニアとして、Cloud Audit Logsからテーブルの参照回数を取得したい。これにより、INFORMATION_SCHEMAでは取得できない詳細な監査情報を活用できる。

#### Acceptance Criteria
1. ユーザーがプロジェクトIDを指定して実行した場合、テーブル参照回数取得機能はCloud LoggingのBigQuery Data Access auditlogからテーブルアクセス情報を取得する
2. auditlogからテーブルアクセス情報を取得した場合、テーブル参照回数取得機能はテーブル読み取りイベント（tableDataRead）を抽出する
3. テーブル読み取りイベントを抽出した場合、テーブル参照回数取得機能はプロジェクト、データセット、テーブル単位で参照回数を集計する
4. テーブル参照回数取得機能は過去の期間（デフォルト30日）のauditlogを対象に集計する
5. auditlogへのアクセス権限がない場合、テーブル参照回数取得機能は明確なエラーメッセージを表示する
6. auditlogが有効化されていない場合、テーブル参照回数取得機能はauditlogの有効化が必要である旨を表示する

### Requirement 3: 複数データソースの統合
**Objective:** データエンジニアとして、INFORMATION_SCHEMAとauditlogの両方のデータを統合したい。これにより、より正確で包括的なテーブル利用状況を把握できる。

#### Acceptance Criteria
1. INFORMATION_SCHEMAとauditlogの両方からデータを取得した場合、テーブル参照回数取得機能は両データソースの参照回数を統合して表示する
2. データを統合する場合、テーブル参照回数取得機能は各データソースごとの参照回数も個別に確認できるようにする
3. 同一テーブルに対する参照がある場合、テーブル参照回数取得機能はデータソース間での重複を考慮した集計を行う
4. 一方のデータソースのみ利用可能な場合、テーブル参照回数取得機能は利用可能なデータソースのみで集計結果を提供する
5. テーブル参照回数取得機能はユーザーがデータソースを選択できるオプションを提供する

### Requirement 4: 結果の出力
**Objective:** データ基盤運用者として、テーブル参照回数の結果を様々な形式で出力したい。これにより、分析やレポート作成に活用できる。

#### Acceptance Criteria
1. 集計が完了した場合、テーブル参照回数取得機能はテーブル名と参照回数の一覧を標準出力に表示する
2. テーブル参照回数取得機能は参照回数の降順でソートして結果を表示する
3. ユーザーがCSV出力オプションを指定した場合、テーブル参照回数取得機能は結果をCSVファイルとして出力する
4. ユーザーがJSON出力オプションを指定した場合、テーブル参照回数取得機能は結果をJSONファイルとして出力する
5. テーブル参照回数取得機能は出力結果にプロジェクトID、データセット名、テーブル名、参照回数、データソースを含める

### Requirement 5: フィルタリングと期間指定
**Objective:** データエンジニアとして、特定の条件でフィルタリングや期間を指定したい。これにより、必要な範囲に絞った分析ができる。

#### Acceptance Criteria
1. ユーザーがデータセット名を指定した場合、テーブル参照回数取得機能は指定されたデータセットのテーブルのみを集計対象とする
2. ユーザーがテーブル名パターンを指定した場合、テーブル参照回数取得機能はパターンに一致するテーブルのみを集計対象とする
3. ユーザーが期間を指定した場合、テーブル参照回数取得機能は指定された期間のデータのみを集計対象とする
4. ユーザーが最小参照回数を指定した場合、テーブル参照回数取得機能は指定回数以上参照されたテーブルのみを結果に含める
5. 指定された期間がデータ保持期間を超える場合、テーブル参照回数取得機能は利用可能な期間の制限についてユーザーに通知する

### Requirement 6: エラーハンドリングと堅牢性
**Objective:** データエンジニアとして、エラーが発生しても適切に処理されることを期待したい。これにより、安定した運用ができる。

#### Acceptance Criteria
1. BigQuery APIへの接続が失敗した場合、テーブル参照回数取得機能は接続エラーの詳細とリトライの方法を表示する
2. 認証情報が無効または期限切れの場合、テーブル参照回数取得機能は認証の再設定方法を案内する
3. クエリ実行中にタイムアウトが発生した場合、テーブル参照回数取得機能はタイムアウト設定の調整方法を表示する
4. 大量のデータを処理している間、テーブル参照回数取得機能は進捗状況をユーザーに表示する
5. 予期しないエラーが発生した場合、テーブル参照回数取得機能はエラーログを出力し、ユーザーにフィードバックを提供する
